/* @flow */

import { NoSound } from './constants'

import { nullthrows } from '../util'
import { zzfxM } from '../libs/zzfxm/zzfxm.min'
import { zzfx, zzfxP } from '../libs/zzfxm/zzfx'

type SoundName =
  | 'death'
  | 'hit'
  | 'laser'
  | 'pickup'
  | 'powerup'

const music = { buffer: null, current: null }
const soundbank: {[SoundName]: Array<mixed>} = {}

function renderSong (song: Array<mixed>): Promise<empty> {
  return new Promise(resolve => {
    setTimeout(() => resolve(zzfxM(...song)), 20)
  })
}

export async function initSounds () {
  /* eslint-disable no-sparse-arrays */
  soundbank.death = [,, 48, 0.05, 0.24, 0.47, 4, 3, 3, -5,,,, 1,, 0.1,, 0.3, 0.09]
  soundbank.hit = [,, 438, 0.02, 0.03, 0.17, 4, 2.6,,,,, 0.04, 0.9, 12, 0.1,, 0.46, 0.02, 0.08, 198]
  soundbank.laser = [1.1,, 227, 0.01, 0.17, 0.07, 2, 0.6, 6, 17,,,,, 15, 0.5, 0.27, 0.92, 0.2,, 794]
  soundbank.pickup = [,, 397,, 0.03, 0.07,, 0.6, 1, -37, 240, 0.05,,,,,, 0.87, 0.01]
  soundbank.powerup = [,, 460, 0.1, 0.23, 0.15, 1, 2.8, 9,, 280, 0.08, 0.06,,,,, 0.71, 0.21]
  /* eslint-enable no-sparse-arrays */

  // eslint-disable-next-line no-sparse-arrays
  music.buffer = await renderSong([[[1.8, 0, 72,,, 0.2,, 4, -2, 6, 50, 0.15,, 6], [, 0, 655,,, 0.09, 3, 1.65,,,,, 0.02, 3.8, -0.1,, 0.2], [1.2, 0, 23,,, 0.2, 3, 4,,, 3, 0.9, 0.05], [1.5, 0, 740,,, 0.15, 2, 0.2, -0.1, -0.15, 9, 0.02,, 0.1, 0.12,, 0.06]], [[[3, -1, 13, 13, 13, 8, 13,,,,,,,,,,,, 11, 11, 11, 6, 11,,,,,,,,,,,, 10, 10, 10, 6, 10,,,,,,,,, 6, 8, 10, 8, 8, 8, 5, 13,, 8, 8, 8, 5, 13,,,,,,], [, 1, 25,, 25,,,,,,,,,,,,, 25, 25,, 25,,,,,,, 25,,, 25,, 25, 25, 25,, 25,,,,,,,,,,, 25, 25, 25, 25,, 25,,,,,,,,,,,,,,], [2, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13,,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,,]], [[3, -1, 13, 13, 13, 8, 13,,,,,,,,,,,, 11, 11, 11, 6, 11,,,,,,,,,,,, 10, 10, 10, 6, 10,,,,,,,,, 6, 8, 10, 8, 8, 8, 5, 13,, 8, 8, 8, 5, 13, 8, 8, 8, 5, 13], [2, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25, 27, 11,, 23,, 11, 11, 23, 11,, 11, 23, 11, 11, 11, 23, 22, 18,, 30,, 18, 18, 30, 18,, 18, 30, 18, 18, 18, 30, 22, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,,], [, 1, 25,, 25,,,,,,,,,,,,, 25, 25,, 25,,,,,,,,,,,,,, 25,, 25,,,,,,,,,,, 25, 25, 25, 25,, 25,,,,,,,,,,,,,,], [1, 1,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,, 13, 13, 13, 13, 13, 13, 13, 13]], [[3, -1, 13, 13, 13, 8, 13,, 13, 15, 17, 17, 15, 13, 20, 20, 18, 17, 18,,,, 17,, 15,,,, 17,, 18,, 22, 22, 22,, 18,,,, 25, 25, 25,, 22,,, 18, 20, 22, 20,,,,,,,,,,,,,,,,], [2, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25, 27, 11,, 23,, 11, 11, 23, 11,, 11, 23, 11, 11, 11, 23, 22, 18,, 30,, 18, 18, 30, 18,, 18, 30, 18, 18, 18, 30, 22, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,,], [, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,,], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13]], [[3, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 11,, 23,, 11, 11, 23, 11,, 11, 23, 11, 11, 11, 23,, 10,, 22,, 10, 10, 22, 10,, 10, 22, 10, 10, 6, 8, 10, 20, 25, 20, 20, 25, 20,, 20, 25, 20, 20, 20, 25,, 20,,], [2, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,,], [, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,,], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13]], [[3, -1, 13,,,,,, 8,, 17, 15, 13,, 17, 15, 13,, 15,,,, 10, 13, 15, 10, 13, 15, 10, 13, 15, 10, 13, 15, 12,,,,,, 8, 15,,,,, 17, 15, 13, 8, 13,,,,,, 10, 8,, 20, 20, 20, 20, 20, 20, 20], [2, -1, 13,, 25,, 13, 13, 25, 13,, 13, 25, 13, 13, 13, 25,, 15,, 27,, 15, 15, 27, 15,, 15, 27, 15, 15, 15, 27, 32, 20,, 32,, 20, 20, 32, 20,, 20, 32, 20, 20, 20, 32,, 13,, 25,, 13, 13, 25, 20,, 20, 32, 20, 20, 20, 32,,], [, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,,], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13]], [[3, -1, 13,,,,,, 8,, 17,,,, 18, 17, 15,, 18,,,, 13,,,, 10,,,, 6,,,, 8, 12, 15, 12, 20,, 8, 12, 15, 12, 20,, 22, 20, 15,, 13,,,,,, 10,, 8,,,,, 8, 20, 8], [2, -1, 13,, 25, 25, 13,, 25, 25, 13,, 25, 25, 13,, 25, 25, 15,, 27, 27, 15,, 27, 27, 15,, 27, 27, 15,, 27, 27, 20,, 32, 32, 20,, 32, 32, 20,, 32, 32, 20,, 32, 32, 13,, 25, 25, 13,, 25, 25, 20,, 32, 32, 20,, 32, 34], [, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,,], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13]], [[3, -1, 13,,,,,, 8,, 17,,,, 18, 17, 15,, 18,,,, 13,,,, 10,,,, 6,,,, 8, 12, 15, 12, 20,, 8, 12, 15, 12, 20,, 22, 20, 15,, 13,,,,,, 10,, 8,,,,, 8, 20, 8], [, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,,], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13]], [[, 1, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,,,, 25, 25,, 25, 25,,,,,, 25,,,, 25,,, 25,,,, 25, 25, 25, 25, 25], [1, 1,,,,, 13,,,,,,,, 13,,,,,,,, 13,,,,,,,, 13,, 13,,,,,, 13,,,,,,,, 13,,,,,,,, 13, 13,, 13,, 13, 13, 13, 13, 13, 13, 13]]], [0, 1, 2, 2, 3, 3, 2, 2, 4, 4, 5, 6, 6, 7, 2, 2, 3]])
}

export function playSound (name: SoundName) {
  const sound = nullthrows(soundbank[name])
  NoSound || zzfx(...sound)
}

export function playMusic () {
  if (NoSound) return
  // music.current.stop()
  // music.current = null
  if (music.current == null) {
    music.current = zzfxP(...music.buffer)
    music.current.loop = true
  }
}
